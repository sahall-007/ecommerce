<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin home page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test:hover {
            background-color: rgb(238, 238, 238);
        }

        .sidebar {
            transition: transform 0.3s ease;
        }

        @media (max-width: 767.98px) {
            .sidebar {
                position: fixed;
                top: 56px;
                /* height of navbar */
                left: 0;
                width: 200px;
                height: 100vh;
                background-color: #000;
                color: white;
                z-index: 1050;
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <!-- //  ========== NAVBAR ========== -->

    <%- include("../partials/admin/navbar.ejs") %>

        <div class="container px-0 mt-5">
            <div class="row justify-content-md-between justify-content-center">
                <div
                    class=" col col-md-3 col-lg-2 border border-secondary text-secondary rounded sidebar align-self-start p-0">

                    <%- include("../partials/admin/sidebarLinks.ejs") %>

                </div>
                <% if(orders){ %>

                    <% 
                        let totalRevenue = 0, totalOrder = 0, totalDiscountPrice = 0, couponDiscountAmount = 0

                        orders?.forEach(ele => {
                            totalRevenue += ele?.payablePrice
                            totalOrder++
                            totalDiscountPrice += ele?.totalDiscountPrice
                            couponDiscountAmount += ele?.discountAmount
                            
                        })
                    %>
                    <div class="card col-10 col-md-8 col-lg-9  px-0 mx-3 main-content">
    
                        <div class="card-body">
                            <!-- Sales Report Content Starts Here -->
    
                            <!-- Page Title -->
                            <h3 class="card-title mb-4">Sales Report</h3>
    
                            <!-- Date Range Filter -->
                            <form action="/admin/salesReport/time" method="get">
                                <div class="row mb-4 justify-content-between">                              
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label for="selectTime" class="form-label">Select time frame</label>
                                        <select class="w-100 rounded p-2" id="selectTime" name="timeFrame" onchange="customDate(this)">
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                            <option value="custom" >Custom</option>
                                        </select>
                                    </div>                          
                                    <div class="col-12 col-md-6 col-lg-3 d-none customTimeFrames">
                                        <label for="startDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate">
                                        <p class="text-danger" id="startMsg" style="font-size: small;"></p>                                    
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-3 d-none customTimeFrames">
                                        <label for="endDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate">
                                        <p class="text-danger" id="endMsg" style="font-size: small;"></p>                                    
                                    </div>
                                    <div class="col-12 col-lg-3 d-flex align-items-end mt-3 mt-lg-0">
                                        <button type="submit" class="btn btn-primary me-1" id="applyFilter">Apply</button>
                                        <button class="btn btn-outline-danger me-1" onclick="downloadPDF(event)">PDF</button>
                                        <button class="btn btn-outline-success" onclick="downloadExcel(event)">Excel</button>
                                    </div>
                                </div>
                            </form>
                            
    
                            <!-- Summary Cards -->
                            <div class="row mb-4">
                                <div class="col-6 col-lg-3 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h5 class="card-subtitle mb-2 text-muted">Total Revenue</h5>
                                            <h3 class="card-text text-primary">&#8377; <span id="totalRevenue"><%= totalRevenue %></span></h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h5 class="card-subtitle mb-2 text-muted">Total Orders</h5>
                                            <h3 class="card-text text-success"><span id="totalOrder"><%= totalOrder %></span></h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-3">
                                    <div class="card border-info">
                                        <div class="card-body">
                                            <h5 class="card-subtitle mb-2 text-muted">Total discount</h5>
                                            <h3 class="card-text text-info">&#8377; <span id="totalDiscountPrice"><%= totalDiscountPrice %></span></h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body">
                                            <h5 class="card-subtitle mb-2 text-muted">Coupon discount</h5>
                                            <h3 class="card-text text-warning">&#8377; <span id="couponDiscountAmount"><%= couponDiscountAmount %></span></h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Sales Table -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Detailed Sales Data</h5>
                                </div>
                                <div class="card-body p-0">                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">#</th>
                                                    <th scope="col">Order ID</th>
                                                    <th scope="col" class="text-center">Date</th>
                                                    <th scope="col" class="text-center">Customer</th>
                                                    <th scope="col">Amount</th>
                                                    <th scope="col">Discount</th>
                                                    <th scope="col">Coupon</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableDatas">
                                                <% orders?.forEach((ele, index) => { %>
                                                    <tr>
                                                        <td><%= index + 1 %></td>
                                                        <td>#<%= ele.orderId %></td>
                                                        <td class="text-center">
                                                            <%= new Date(ele?.createdAt).toLocaleDateString('en-GB', {
                                                                day: 'numeric',
                                                                month: 'short',
                                                                year: 'numeric',
                                                            }) %>
                                                        </td>
                                                        <td class="text-center"><%= ele?.user?.username %></td>
                                                        <td>&#8377; <%= ele?.payablePrice %></td>
                                                        <td>&#8377; <%= ele?.totalDiscountPrice %></td>
                                                        <td>&#8377; <%= ele?.discountAmount %></td>
                                                    </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
    
                                <!--==========PAGINATION============ -->
                                <!-- <div class="card-footer d-flex justify-content-between align-items-center">
                                    <small class="text-muted" style="visibility: hidden;">Showing 1 to 3 of 1,423
                                        entries</small>
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
    
                                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                                        </ul>
                                    </nav>
                                </div> -->
                            </div>
                        </div>
                    </div>
                <% } %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
<script>
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('menuToggle');

    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('show');
    });

    document.getElementById("applyFilter").addEventListener('click', async (event) => {
        event.preventDefault()

        const tableDatas = document.getElementById("tableDatas")

        const startMsg = document.getElementById("startMsg")
        const endMsg = document.getElementById("endMsg")
            
        const selectTime = document.getElementById("selectTime").value
        const startDate = document.getElementById("startDate").value
        const endDate = document.getElementById("endDate").value

        if(new Date(endDate) >  Date.now() && new Date(startDate) >  Date.now()){
            startMsg.textContent = "Start date cant be greater than current date"
            endMsg.textContent = "End date cant be greater than current date"
         
            return
        }
        if(new Date(endDate) >  Date.now()){
            endMsg.textContent = "End date cant be greater than current date"
            startMsg.textContent = ""

            return
        }
        if(new Date(startDate) >  Date.now()){
            startMsg.textContent = "Start date cant be greater than current date"
            endMsg.textContent = ""
            
            return
        }
        if(new Date(endDate) < new Date(startDate)){
            endMsg.textContent = "End date cant be less than start date"
            startMsg.textContent = ""
        }
        else{ 
            startMsg.textContent = ""
            endMsg.textContent = ""
        }

        try{
            const request = await fetch('/admin/applyFilter', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ timeFrame: selectTime, startDate, endDate })
            })

            const res = await request.json()

            if(res.orders.length > 0){
            
                let totalRevenue = 0, totalOrder = 0, totalDiscountPrice = 0, couponDiscountAmount = 0

                res?.orders?.forEach(ele => {
                    totalRevenue += ele?.payablePrice
                    totalOrder++
                    totalDiscountPrice += ele?.totalDiscountPrice
                    couponDiscountAmount += ele?.discountAmount
                    
                })

                document.getElementById("totalRevenue").textContent = totalRevenue
                document.getElementById("totalOrder").textContent = totalOrder
                document.getElementById("totalDiscountPrice").textContent = totalDiscountPrice
                document.getElementById("couponDiscountAmount").textContent = couponDiscountAmount

                tableDatas.innerHTML = ''
                for(let i=0; i<res.orders.length; i++){
                    tableDatas.innerHTML += `
                        <tr>
                            <td>${i+1}</td>
                            <td>#${res.orders[i].orderId}</td>
                            <td class="text-center">
                                ${new Date(res.orders[i].createdAt).toLocaleDateString('en-GB', {
                                    day: 'numeric',
                                    month: 'short',
                                    year: 'numeric',
                                })}
                            </td>
                            <td class="text-center">${res.orders[i]?.user?.username}</td>
                            <td>&#8377; ${res.orders[i]?.payablePrice}</td>
                            <td>&#8377; ${res.orders[i]?.totalDiscountPrice}</td>
                            <td>&#8377; ${res.orders[i]?.discountAmount}</td>
                        </tr>
                    `
                }
            }
        }
        catch(err){
            alert("sales report filter error")
            console.log(err)
        }

    })

    // to make the start and end date appear when we select custom on the select input
    function customDate(element){
        const customTimeFrames = document.querySelectorAll(".customTimeFrames")
        if(element.value == "custom"){
            customTimeFrames.forEach(ele => {
                ele.classList.remove("d-none")
            })
        }
        else{
            customTimeFrames.forEach(ele => {
                ele.classList.add("d-none")
            })
        }
    }

    let timeFrame = "<%= timeFrame %>"

    async function downloadPDF(event){
        event.preventDefault()
        const selectTime = document.getElementById("selectTime").value
        const startDate = document.getElementById("startDate").value
        const endDate = document.getElementById("endDate").value
        window.location.href = `/admin/pdfSalesReport?timeFrame=${selectTime}&startDate=${startDate}&endDate=${endDate}`
    }

    async function downloadExcel(event){
        event.preventDefault()
        const selectTime = document.getElementById("selectTime").value
        const startDate = document.getElementById("startDate").value
        const endDate = document.getElementById("endDate").value
        window.location.href = `/admin/excelSalesReport?timeFrame=${selectTime}&startDate=${startDate}&endDate=${endDate}`
    }

</script>

</body>

</html>