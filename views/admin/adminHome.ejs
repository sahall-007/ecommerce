<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin home page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        var _seed = 42;
        Math.random = function () {
            _seed = _seed * 16807 % 2147483647;
            return (_seed - 1) / 2147483646;
        };
    </script>
    <style>
        .test:hover {
            background-color: rgb(238, 238, 238);
        }

        .sidebar {
            transition: transform 0.3s ease;
        }

        @media (max-width: 767.98px) {
            .sidebar {
                position: fixed;
                top: 56px;
                /* height of navbar */
                left: 0;
                width: 200px;
                height: 100vh;
                background-color: #000;
                color: white;
                z-index: 1050;
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <!-- //  ========== NAVBAR ========== -->

    <%- include("../partials/admin/navbar.ejs") %>

        <div class="container px-0 mt-5">
            <div class="row justify-content-md-between justify-content-center">
                <div
                    class=" col col-md-3 col-lg-2 border border-secondary text-secondary rounded sidebar align-self-start p-0">

                    <%- include("../partials/admin/sidebarLinks.ejs") %>

                </div>
                <div class="card col-10 col-md-8 col-lg-9  px-0 mx-3 main-content">
                    <div class="card-body">
                        <div class="m-2 row justify-content-end">
                            <div class="col-9 col-md-6 col-lg-3">
                                <select class="w-100 rounded p-2" id="selectTime" name="timeFrame">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="col-3 col-md-2 col-lg-1">
                                <button type="submit" class="btn btn-primary me-1" onclick="applyFilter(event)">Apply</button>
                            </div>


                            <!-- <a href="/admin/dashboard?timeFrame=weekly" class="btn btn-outline-secondary">Weekly</a>
                            <a href="/admin/dashboard?timeFrame=monthly" class="btn btn-outline-secondary">Monthly</a>
                            <a href="/admin/dashboard?timeFrame=yearly" class="btn btn-outline-secondary">Yearly</a> -->
                        </div>
                        <!-- Sales Chart -->
                        <div class="container">
                            <div class="row">

                                <div class="col-12 col-lg-8 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                    <h5 class="mb-0">Sales Trend</h5>
                                    </div>
                                    <div class="card-body">
                                    <div id="chart"></div>
                                    </div>
                                </div>
                                </div>

                                <div class="col-12 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                    <h5 class="mb-0">Order Status</h5>
                                    </div>
                                    <div class="card-body">
                                    <div id="pie"></div>
                                    </div>
                                </div>
                                </div>

                            </div>
                        </div>

                        <% if(topSellingProducts){ %>
                            <div class="row gap-3 justify-content-center">
                                <div class="card col-12 col-lg-8">
                                    <div class="card-body  table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">#</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col" class="text-center">Price</th>
                                                    <th scope="col" class="text-center">Variant</th>
                                                    <th scope="col" class="text-center">Sold</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topSellingProductsTable">
                                                
                                                <% topSellingProducts?.variantCount?.forEach((ele, index)=> { %>
                                                    <tr>
                                                        <td>
                                                            <%= index + 1%>
                                                        </td>
                                                        <td>
                                                            <%= ele.name %>
                                                        </td>
                                                        <td class="text-center">
                                                            <%= ele.price %>
                                                        </td>
                                                        <td class="text-center">
                                                            <%= ele.ram %> | <%= ele.storage %> | <%= ele.color %>
                                                        </td>
                                                        <td class="text-center">
                                                            <%= ele.count %>
                                                        </td>
                                                    </tr>
                                                <% }) %>
                                            


                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-3">
                                    <div class="card mb-1">
                                        <div class="card-body  table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th scope="col">#</th>
                                                        <th scope="col">Categroy</th>
                                                        <th scope="col">Sold</th>
        
                                                    </tr>
                                                </thead>
                                                <tbody id="topSellingCategoryTable">
        
                                                    
                                                    <% topSellingProducts?.categoryCount?.forEach((ele, index)=> { %>
                                                        <tr>
                                                            <td>
                                                                <%= index + 1%>
                                                            </td>
                                                            <td>
                                                                <%= ele._id %>
                                                            </td>
                                                            <td class="text-center">
                                                                <%= ele.count %>
                                                            </td>
                                                        </tr>
                                                    <% }) %>
                                                    
        
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-body  table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th scope="col">#</th>
                                                        <th scope="col">Brand</th>
                                                        <th scope="col">Sold</th>
        
                                                    </tr>
                                                </thead>
                                                <tbody id="topSellingBrandsTable">
        
                                                    
                                                    <% topSellingProducts?.brandCount?.forEach((ele, index)=> { %>
                                                        <tr>
                                                            <td>
                                                                <%= index + 1%>
                                                            </td>
                                                            <td>
                                                                <%= ele._id %>
                                                            </td>
                                                            <td class="text-center">
                                                                <%= ele.count %>
                                                            </td>
                                                        </tr>
                                                    <% }) %>
                                                
        
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>

            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"></script>
        <script>
            let chartDates = <%- JSON.stringify(chartDates) %>
            let chartValues = <%- JSON.stringify(chartValues) %>
            let pieFields = <%- JSON.stringify(pieFields) %>
            let pieValues = <%- JSON.stringify(pieValues) %>

            
            let options, chart, pieOptions, pieChart

            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.getElementById('menuToggle');

            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('show');
            });

            async function applyFilter (event){
                const selectTime = document.getElementById("selectTime").value

                try{
                    const request = await fetch(`/admin/dashboard`, {
                        method: "POST",
                        headers: { "Content-Type" : "application/json" },
                        body: JSON.stringify({timeFrame: selectTime})
                    })

                    const res = await request.json()

                    chartDates = res.chartDates
                    chartValues = res.chartValues
                    pieFields = res.pieFields
                    pieValues = res.pieValues

                    // to update the top selling products, category, brands
                    if(res?.topSellingProducts){
                        // getting the id's of the tables to update them
                        const topSellingProductsTable = document.getElementById("topSellingProductsTable")
                        const topSellingCategoryTable = document.getElementById("topSellingCategoryTable")
                        const topSellingBrandsTable = document.getElementById("topSellingBrandsTable")

                        // to update the top selling product/variant
                        if(res?.topSellingProducts?.variantCount?.length > 0){
                            topSellingProductsTable.innerHTML = ""

                            res?.topSellingProducts?.variantCount.forEach((ele, index) => {
                                topSellingProductsTable.innerHTML += `
                                    <tr>
                                        <td>
                                            ${index+1}
                                        </td>
                                        <td>
                                            ${ele.name}
                                        </td>
                                        <td class="text-center">
                                            ${ele.price}
                                        </td>
                                        <td class="text-center">
                                            ${ele.ram} | ${ele.storage} | ${ele.color}
                                        </td>
                                        <td class="text-center">
                                            ${ele.count}
                                        </td>
                                    </tr>
                                `
                            })

                        }
                        
                        // to update the top selling category
                        if(res?.topSellingProducts?.categoryCount?.length > 0){
                            topSellingCategoryTable.innerHTML = ""

                            res?.topSellingProducts?.categoryCount.forEach((ele, index) => {
                                topSellingCategoryTable.innerHTML += `
                                    <tr>
                                        <td>
                                            ${index+1}
                                        </td>
                                        <td>
                                            ${ele._id}
                                        </td>                                        
                                        <td class="text-center">
                                            ${ele.count}
                                        </td>
                                    </tr>
                                `
                            })

                        }

                        // to update the top selling brands
                        if(res?.topSellingProducts?.brandCount?.length > 0){
                            topSellingBrandsTable.innerHTML = ""

                            res?.topSellingProducts?.brandCount.forEach((ele, index) => {
                                topSellingBrandsTable.innerHTML += `
                                    <tr>
                                        <td>
                                            ${index+1}
                                        </td>
                                        <td>
                                            ${ele._id}
                                        </td>                                        
                                        <td class="text-center">
                                            ${ele.count}
                                        </td>
                                    </tr>
                                `
                            })
                        }

                    }
                    
                    // to update the line chart
                    chart.updateOptions({                    
                        xaxis: {
                            categories: chartDates
                        },
                        series: [{
                            data: chartValues
                        }]
                    })
                    
                    // to update the pie chart
                    pieChart.updateSeries(pieValues)

                }
                catch(err){
                    alert("sales chart select time error")
                    console.log(err)
                }
            }



            options = {
                series: [{
                    name: "Sales",
                    data: chartValues
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    zoom: {
                        enabled: false
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'straight'
                },
                // title: {
                //     text: 'Product Trends by Month',
                //     align: 'left'
                // },
                grid: {
                    row: {
                        colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                        opacity: 0.5
                    },
                },
                xaxis: {
                    categories: chartDates
                }
            };

            chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();

            pieOptions = {
                series: pieValues, 
                chart: {
                    type: 'donut',
                    height: 350 
                },
                labels: pieFields, 
                legend: {
                    position: 'bottom'  
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };

            pieChart = new ApexCharts(document.querySelector("#pie"), pieOptions);
            pieChart.render();


        </script>

</body>

</html>